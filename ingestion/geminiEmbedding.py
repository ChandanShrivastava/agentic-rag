import vertexai
from vertexai.language_models import TextEmbeddingModel, TextEmbeddingInput
import os
import time

# --- Configuration ---
PROJECT_ID = "valid-gizmo-465804-n3"  # Replace with your Google Cloud Project ID
REGION = "asia-northeast1"            # Choose a suitable region (e.g., us-central1)

# Initialize Vertex AI
# If using a service account key file directly:
# from google.oauth2 import service_account
# credentials = service_account.Credentials.from_service_account_file("path/to/your-service-account-key.json")
# vertexai.init(project=PROJECT_ID, location=REGION, credentials=credentials)
# If authenticated via `gcloud auth application-default login`:
vertexai.init(project=PROJECT_ID, location=REGION)

# Load the embedding model
# The model ID for Gemini Embedding is 'gemini-embedding-001'
model = TextEmbeddingModel.from_pretrained("gemini-embedding-001")

# Define your text(s)
# Note: gemini-embedding-001 supports only a single input text per request,
# but the SDK's get_embeddings method can handle a list of texts by making multiple requests internally.
# However, each individual text in the list is subject to the 2048 token limit.
texts_to_embed = [
    "This is a short sentence for embedding.",
    "Another example sentence.",
    # Your 5000-word text would go here, but remember the token limit!
]

# --- Important for 5000-word texts: Token Limit Handling ---
# gemini-embedding-001 has a maximum input token length of 2048 tokens.
# A 5000-word text will typically be 7000-10000+ tokens.
# Therefore, you *must* chunk your 5000-word text before sending it for embedding.

def get_chunks(text, max_tokens=2048, overlap_tokens=0):
    # This is a simplified chunking strategy. For production,
    # consider more sophisticated methods (e.g., respecting sentence boundaries,
    # using a proper tokenizer to count tokens accurately).
    words = text.split()
    chunks = []
    current_chunk = []
    current_length = 0

    # Rough word-to-token approximation (adjust as needed for your content)
    # A common rule of thumb is 1 word = ~1.3-1.5 tokens
    avg_tokens_per_word = 1.3
    max_words_per_chunk = int(max_tokens / avg_tokens_per_word)
    overlap_words = int(overlap_tokens / avg_tokens_per_word)

    i = 0
    while i < len(words):
        chunk_words = words[i : i + max_words_per_chunk]
        chunks.append(" ".join(chunk_words))
        i += (max_words_per_chunk - overlap_words) # Move by chunk size minus overlap
        if i >= len(words) and len(chunk_words) < max_words_per_chunk: # Handle last partial chunk
             break # Exit if it's already the last chunk

    return chunks

your_5000_word_text = """
    # Your actual 5000-word text goes here.
    # For demonstration, let's create a long string.
    """
# Repeat a sentence many times to simulate a long text
your_5000_word_text =  """1. A medication or fluid delivery and control system comprising: (a) at least one apparatus comprising at least one sensor for measuring pharmacodynamic (PD), pharmacokinetic (PK), or both PD and PK parameters in a subject; (b) an infusion device with a rate of infusion which is increased, decreased, or maintained at a given level of infusion based on said PD, PK, or both parameters; and (c) a controller for receiving said PD, PK or both PD and PK parameters and, based on said parameters, increasing, decreasing or maintaining the rate of infusion of said infusion device. 2. The medication or fluid delivery and control system according to claim 1 in which a photoplethysmographic signal is utilized to derive information on the PD and/or PK status of a subject and to control infusion rate in a closed-loop or an open-loop system. 3. The medication or fluid delivery and control system according to claim 2 wherein said photoplethysmographic signal is obtained from the subject's nasal ala as a Single Point of Contact (SPOC) device. 4. The medication or fluid delivery and control system according to claim 1 further comprising any one or a combination of the following elements: 1. a battery pack or access to existing power in the warfighter ensemble 1/1; 2. an accelerometer or other motion sensing device 1/2 worn on the helmet of a subject 1/3 or other location on the head (e.g. behind the subject's ear) which provides signals indicating whether a warfighter is actively moving or is inactive to provide a \u201cwake-up\u201d signal to the sensing system 1/4 so that it may remain in a standby status until needed; 3. at least one, and preferably two SPOC sensor assemblies 3/300 each containing pulse oximeter components (LEDs [photodiodes] 3/301 and photodetector 3/302), nasal pressure or flow sensors, 3/304, optionally, one of two ECG electrodes, 3/305 (the other to be placed in the undergarments or on the torso of the warfighter); 4. means to fix the SPOC sensors securely to the subject, selected from the group consisting of retainer device, 3/306, which fits over the bridge of the subject's nose and/or up to the helmet or other fixation point on the forehead, for example, using a headband, 3/307, wherein the forehead band, 3/307, communications ensemble or the helmet optionally contain reservoirs of medications and or fluids, 3/308, (3/308A, 3/308B, 3/308C, 3/308D, represent separate reservoirs with same or different fluids/medications), each of which is linked (via communication lines 3/308a, 3/308b, 3/308c, 3/308d to and activated for release of fluid/medications by the computer/CPU 3/320 which controls the closed-loop system, and other components/sensors of the system; such that said computer/CPU, 3/320, receives signals, 3/321, from the PD, PK or PD+PK sensors 3/301, 3/302, 3/305, affixed to the subject via communication line(s) 3/301a, 3/302a, 3/305a; 5. a medication or fluid delivery system selected from: a small tube, 3/303, incorporated into the assembly and for emplacement inside the subject's nostril for orientation toward the nasal septum (nasal epithelium/mucosa) which delivers aerosols and/or non-aerosols of pre-metered doses of medications (e.g. opioids, anxiolytics, steroids, vasoactive drugs, and the like); or in alternate configurations, the delivery device comprises a needle/catheter for insertion subcutaneously, rectally, intravenously, intraperitoneally, intraarterially, intracardiacly, intraosseously; 6. where utilized, the intranasal tube, 3/303, or other medication or fluid delivery system connected to a drug delivery system capable of providing aerosolized and/or non-aerosolized medication through the nasal epithelium delivery tube 3/303, said aerosolized and/or non-aerosolized medication(s) optionally stored in pressurized canisters, 3/308, adapted to provide metered doses upon actuation of a valve or a small pump that delivers aerosolized and/or non-aerosolized doses from a given container, 3/308, via delivery line(s) 3/309 connected to said nasal epithelium delivery tube 3/303; 7. optionally, nitric oxide, histamine, methacholine included in the medication delivery system, either as part of the medication compositions or as a separate feed to the nasal mucosa, to increase permeability of the nasal mucosa to the delivered medications; 8. highly concentrated doses of opioids (fentanyl, sufentanyl); opioid antagonists (naltrexone/naloxone for \u201crecovery\u201d if too large a dose of opioids is delivered); vasoactive drugs, particularly vasopressin; steroids (dexamethasone); dissociative agents such as ketamine; anxiolytics (benzodiazepines, gabapentin, pregabalin), included as single component compositions which are separately deliverable to a subject in need of such agents, based on measurements of their PD parameters, provided via separate infusion lines to the subject or may be combined for delivery through a single line; 9. canisters or containers for medications and fluids, 3/308, adapted so that they can be removably but securely inserted into the system (e.g. canisters or container that can be snapped into the system by engaging clips and holding compartments adapted for protection and engagement of such canisters or containers) so that different medication combinations can be provided; 10. a small central processing unit (CPU), 2/210, 3/320, including algorithms/software stored in RAM, 2/220, and/or ROM, 2/230m facilitate closed-loop (servo) delivery of medications and control of the medical devices (sensors and infusion mechanics); 11. small infusion pumps (e.g. ambIT PCA pump, http://www.ambitpump.com), 3/321, deliver volume expanders (hypertonic saline; dextrans) via subcutaneous, intraosseous, or IV routes when available; 12. a second \u201cperipheral\u201d pulse oximeter sensor to provide information on volume status, or the status of an injured extremity; 13. nasal pressure/flow sensors, 3/304, and/or PPG sensors, 3/301, 3/302, utilized to detect phase of respiration and meter doses of medication only during the inspiratory phase; said system to operate as a complete autonomous care by the warfighter, or with the assistance of other warfighters in the combat zone, by emplacing the SPOC sensor assembly if the warfighter is unconscious or unable to apply the assembly to him/herself; or comprising remote communication of the vital sign information and control of the WARCARE\u2122 system once the SPOC is emplaced. 5. The system according to claim 4 wherein said system optionally remains in place as the warfighter is transferred to higher levels of medical care for both monitoring and drug therapy, and, wherein, once IV access is obtained, drug delivery can be switched to this route with said WARCARE\u2122 system optionally remaining in place through all levels of medical care and it being adapted to interface with other medical treatment and monitoring systems. 6. The system according to claim 5, wherein the WARCARE\u2122 assembly is in place as in integral part of the combatant's helmet and/or telemetry/communications gear. 7. The system according to claim 5 wherein the WARCARE\u2122 system delivers medications in a timely manner through nasal epithelium. 8. The system according to claim 5 wherein said accelerometer or like motion and/or orientation detection sensor, monitors whether a warfighter is actively moving or has suddenly ceased to move, or is used to limit the power consumption of the WARCARE\u2122 system by maintaining it in \u201csleep\u201d mode until it senses a sudden change in the war fighter's level of activity. 9. The system according to claim 8 wherein said accelerometer or like motion sensor is adapted to detect very regular but intense body movement indicative of seizure activity, and to the controller to provide a benzodiazepine or other antiseizure medications if the WARCARE\u2122 system is in place or once the SPOC assembly is emplaced by a fellow combatant. 10. A method for delivering medication or fluid to a subject comprising emplacing on said subject a delivery and control system comprising: (a) at least one apparatus comprising at least one sensor for measuring pharmacodynamic (PD), pharmacokinetic (PK), or both PD and PK parameters in a subject; (b) an infusion device with a rate of infusion which is increased, decreased, or maintained at a given level of infusion based on said PD, PK, or both parameters; and (c) a controller for receiving said PD, PK or both PD and PK parameters and, based on said parameters, increasing, decreasing or maintaining the rate of infusion of said infusion device. 11. The method according to claim 10, said delivery control system further comprising any one or a combination of the following elements: 1. a battery pack or access to existing power in the warfighter ensemble 1/1; 2. an accelerometer or other motion sensing device 1/2 worn on the helmet of a subject 1/3 or other location on the head (e.g. behind the subject's ear) which provides signals indicating whether a warfighter is actively moving or is inactive to provide a \u201cwake-up\u201d signal to the sensing system 1/4 so that it may remain in a standby status until needed; 3. at least one, and preferably two SPOC sensor assemblies 3/300 each containing pulse oximeter components (LED photodiodes 3/301 and photodetector 3/302), nasal pressure/flow sensors, 3/304, optionally, one of two ECG electrodes, 3/305 (the other to be placed in the undergarments or on the torso of the warfighter); 4. means to fix the SPOC sensors securely to the subject, selected from the group consisting of retainer device, 3/306, which fits over the bridge of the subject's nose and/or up to the helmet or other fixation point on the forehead, for example, using a headband, 3/307, wherein the forehead band, 3/307, communications ensemble or the helmet optionally contain reservoirs of medications and or fluids, 3/308, (3/308A, 3/308B, 3/308C, 3/308D, represent separate reservoirs with same or different fluids/medications), each of which is linked (via communication lines 3/308a, 3/308b, 3/308c, 3/308d to and activated for release of fluid/medications by the computer/CPU 3/320 which controls the closed-loop system, and other components/sensors of the system; such that said computer/CPU, 3/320, receives signals, 3/321, from the PD, PK or PD+PK sensors 3/301, 3/302, 3/305, affixed to the subject via communication line(s) 3/301a, 3/302a, 3/305a; 5. a medication or fluid delivery system selected from: a small tube, 3/303, incorporated into the assembly and for emplacement inside the subject's nostril for orientation toward the nasal septum (nasal epithelium) which delivers aerosols and/or non-aerosols of pre-metered doses of medications (e.g. opioids, anxiolytics, steroids, vasoactive drugs, and the like); or in alternate configurations, the delivery device comprises a needle for insertion intravenously, intraperitoneally, intracardiacly; 6. where utilized, the intranasal tube, 3/303, or other medication or fluid delivery system connected to a drug delivery system capable of providing aerosolized and/or non-aerosolized medication through the nasal epithelium delivery tube 3/303, said aerosolized and/or non-aerosolized medication(s) optionally stored in pressurized canisters, 3/308, adapted to provide metered doses upon actuation of a valve or a small pump that delivers aerosolized and/or non-aerosolized doses from a given container, 3/308, via delivery line(s) 3/309 connected to said nasal epithelium delivery tube 3/303; 7. optionally, nitric oxide, histamine, methacholine included in the medication delivery system, either as part of the medication compositions or as a separate feed to the nasal mucosa, to increase permeability of the nasal mucosa to the delivered medications; 8. highly concentrated doses of opioids (fentanyl, sufentanyl); opioid antagonists (naltrexone/naloxone for \u201crecovery\u201d if too large a dose of opioids is delivered); vasoactive drugs, particularly vasopressin; steroids (dexamethasone); dissociative agents such as ketamine; anxiolytics (benzodiazepines, gabapentin, pregabalin), included as single component compositions which are separately deliverable to a subject in need of such agents, based on measurements of their PD parameters, provided via separate infusion lines to the subject or may be combined for delivery through a single line; 9. canisters or containers for medications and fluids, 3/308, adapted so that they can be removably but securely inserted into the system (e.g. canisters or container that can be snapped into the system by engaging clips and holding compartments adapted for protection and engagement of such canisters or containers) so that different medication combinations can be provided; 10. a small central processing unit (CPU), 2/210, 3/320, including algorithms/software stored in RAM, 2/220, and/or ROM, 2/230m facilitate closed-loop (servo) delivery of medications and control of the medical devices (sensors and infusion mechanics); 11. small infusion pumps (e.g. ambIT PCA pump, http://www.ambitpump.com), 3/321, deliver volume expanders (hypertonic saline; dextrans) via subcutaneous, intraosseous, or IV routes when available; 12. a second \u201cperipheral\u201d pulse oximeter sensor to provide information on volume status, or the status of an injured extremity; 13. nasal pressure sensors, 3/304, and/or PPG sensors, 3/301, 3/302, utilized to detect phase of respiration and meter doses of medication only during the inspiratory phase; said system to operate as a complete autonomous care by the warfighter, or with the assistance of other warfighters in the combat zone, by emplacing the SPOC sensor assembly if the warfighter is unconscious or unable to apply the assembly to him/herself; or comprising remote communication of the vital sign information and control of the WARCARE\u2122 system once the SPOC is emplaced. 12. The method according to claim 10 to minimize morbidity, mortality, PTSD, TBI, in an injured warfighter which comprises providing to said warfighter, prior to injury, a self-contained system which (i) obtains measurements of the warfighter's vital signs selected from the group consisting of nasal pressure/flow, electrocardiographic signals, blood pressure, heart rate, arrhythmias, respiratory rate, respiratory effort indicative of work of breathing, inspiratory and expiratory breathing ratios (I:E ratios) and patterns of each indicative of normal respiratory or respiratory depression, blood oxygen content, pulse oximetry (SpO2), blood volume measurements including local arterial blood flow amplitude, venous capacitance and comparative flows and capacitance from two or more site indicative of hypovolemia/shock and/or loss of extremity perfusion, pulse transit time, pulse wave velocity and combinations thereof, (ii) processes said measurements to determine the relative state of health or otherwise of the warfighter and, based on said determination, (iii) infuses appropriate medications and fluids into the warfighter in the field as appropriate to the state of health or otherwise of said warfighter. 13. An apparatus comprising: (a) at least one apparatus comprising at least one sensor for measuring pharmacodynamic (PD), pharmacokinetic (PK), or both PD and PK parameters in a subject; (b) an infusion device with a rate of infusion which is increased, decreased, or maintained at a given level of infusion based on said PD, PK, or both parameters; and (c) a controller for receiving said PD, PK or both PD and PK parameters and, based on said parameters, increasing, decreasing or maintaining the rate of infusion of said infusion device. 14. The apparatus according to claim 13 further comprising any one or a combination of the following elements: 1. a battery pack or access to existing power in the warfighter ensemble 1/1; 2. an accelerometer or other motion sensing device 1/2 worn on the helmet of a subject 1/3 or other location on the head (e.g. behind the subject's ear) which provides signals indicating whether a warfighter is actively moving or is inactive to provide a \u201cwake-up\u201d signal to the sensing system 1/4 so that it may remain in a standby status until needed; 3. at least one, and preferably two SPOC sensor assemblies 3/300 each containing pulse oximeter components (LED 3/301 and photodiode 3/302), nasal pressure sensors, 3/304, optionally, one of two ECG electrodes, 3/305 (the other to be placed in the undergarments or on the torso of the warfighter); 4. means to fix the SPOC sensors securely to the subject, selected from the group consisting of retainer device, 3/306, which fits over the bridge of the subject's nose and/or up to the helmet or other fixation point on the forehead, for example, using a headband, 3/307, wherein the forehead band, 3/307, communications ensemble or the helmet optionally contain reservoirs of medications and or fluids, 3/308, (3/308A, 3/308B, 3/308C, 3/308D, represent separate reservoirs with same or different fluids/medications), each of which is linked (via communication lines 3/308a, 3/308b, 3/308c, 3/308d to and activated for release of fluid/medications by the computer/CPU 3/320 which controls the closed-loop system, and other components/sensors of the system; such that said computer/CPU, 3/320, receives signals, 3/321, from the PD, PK or PD+PK sensors 3/301, 3/302, 3/305, affixed to the subject via communication line(s) 3/301a, 3/302a, 3/305a; 5. a medication or fluid delivery system selected from: a small tube, 3/303, incorporated into the assembly and for emplacement inside the subject's nostril for orientation toward the nasal septum (nasal epithelium) which delivers aerosols and/or non-aerosols of pre-metered doses of medications (e.g. opioids, anxiolytics, steroids, vasoactive drugs, and the like); or in alternate configurations, the delivery device comprises a needle for insertion intravenously, intraperitoneally, intracardiacly; 6. where utilized, the intranasal tube, 3/303, or other medication or fluid delivery system connected to a drug delivery system capable of providing aerosolized and/or non-aerosolized medication through the nasal epithelium delivery tube 3/303, said aerosolized and/or non-aerosolized medication(s) optionally stored in pressurized canisters, 3/308, adapted to provide metered doses upon actuation of a valve or a small pump that delivers aerosolized and/or non-aerosolized doses from a given container, 3/308, via delivery line(s) 3/309 connected to said nasal epithelium delivery tube 3/303; 7. optionally, nitric oxide, histamine, methacholine included in the medication delivery system, either as part of the medication compositions or as a separate feed to the nasal mucosa, to increase permeability of the nasal mucosa to the delivered medications; 8. highly concentrated doses of opioids (fentanyl, sufentanyl); opioid antagonists (naltrexone/naloxone for \u201crecovery\u201d if too large a dose of opioids is delivered); vasoactive drugs, particularly vasopressin; steroids (dexamethasone); dissociative agents such as ketamine; anxiolytics (benzodiazepines, gabapentin, pregabalin), included as single component compositions which are separately deliverable to a subject in need of such agents, based on measurements of their PD parameters, provided via separate infusion lines to the subject or may be combined for delivery through a single line; 9. canisters or containers for medications and fluids, 3/308, adapted so that they can be removably but securely inserted into the system (e.g. canisters or container that can be snapped into the system by engaging clips and holding compartments adapted for protection and engagement of such canisters or containers) so that different medication combinations can be provided; 10. a small central processing unit (CPU), 2/210, 3/320, including algorithms/software stored in RAM, 2/220, and/or ROM, 2/230m facilitate closed-loop (servo) delivery of medications and control of the medical devices (sensors and infusion mechanics); 11. small infusion pumps (e.g. ambIT PCA pump, http://www.ambitpump.com), 3/321, deliver volume expanders (hypertonic saline; dextrans) via subcutaneous, intraosseous, or IV routes when available; 12. a second \u201cperipheral\u201d pulse oximeter sensor to provide information on volume status, or the status of an injured extremity; 13. nasal pressure sensors, 3/304, and/or PPG sensors, 3/301, 3/302, utilized to detect phase of respiration and meter doses of medication only during the inspiratory phase; said system to operate as a complete autonomous care by the warfighter, or with the assistance of other warfighters in the combat zone, by emplacing the SPOC sensor assembly if the warfighter is unconscious or unable to apply the assembly to him/herself; or comprising remote communication of the vital sign information and control of the WARCARE\u2122 system once the SPOC is emplaced. 15. The Single Point of Contact (SPOC) system according to claim 3 comprising a PD, PK, or PD and PK acquisition subsystem for emplacement on a subject, a controller unit for receiving signals from said PD, PK, or PD and PK acquisition subsystem and for processing said signals and, on the basis of such processing, controlling the delivery of agents to the subject and an agent delivery subsystem. 16. The SPOC system according to claim 15 in which any or a combination of the following elements is included: a. the PD acquisition subsystem comprises at least one sensor selected from the group consisting of a nasal pressure sensor, a PPG sensor, ECG sensor and combinations thereof; b. the agent delivery subsystem is physically integral with the PD acquisition subsystem, wherein said agent delivery subsystem comprises a fluid or gas channel for delivery of agent to the nasal epithelium and said PD acquisition subsystem comprises a PPG and a nasal pressure sensor."""


# Chunk the long text
text_chunks = get_chunks(your_5000_word_text,max_tokens=2048, overlap_tokens=0)
print(f"Original text length (words): {len(your_5000_word_text.split())}")
print(f"Number of chunks generated: {len(text_chunks)}")
print(f"Length of first chunk (words): {len(text_chunks[0].split())}")

# Define a task type for your embeddings. This helps the model generate
# embeddings optimized for your specific use case.
# Common task_types include:
# - SEMANTIC_SIMILARITY
# - CLASSIFICATION
# - CLUSTERING
# - RETRIEVAL_DOCUMENT (for documents to be searched)
# - RETRIEVAL_QUERY (for queries used to search documents)
# - YoutubeING (for questions in a QA system)
# - FACT_VERIFICATION
# - CODE_RETRIEVAL_QUERY
task_type_for_chunks = "RETRIEVAL_DOCUMENT" # Best for similarity search of documents

all_embeddings = []
BATCH_LIMIT_GEMINI_EMBEDDING = 1 # gemini-embedding-001 explicitly supports only batch_size=1
REQUEST_DELAY_SECONDS = 0.1 # Add a small delay to avoid hitting rate limits too quickly (adjust as needed)

try:
    for i, chunk_text in enumerate(text_chunks):
        print(f"Processing chunk {i+1}/{len(text_chunks)}...")
        
        # Create a single TextEmbeddingInput object for each chunk
        embedding_input = [TextEmbeddingInput(text=chunk_text, task_type=task_type_for_chunks)]

        # Call get_embeddings with a list containing only one TextEmbeddingInput object
        embeddings_objects = model.get_embeddings(
            embedding_input
            # output_dimensionality=768 # Optional: Reduce dimensions for storage/performance
        )
        
        # The response for a single input will be a list of one embedding object
        if embeddings_objects and len(embeddings_objects) > 0:
            all_embeddings.append(embeddings_objects[0].values)
        else:
            print(f"Warning: No embedding returned for chunk {i+1}")

        time.sleep(REQUEST_DELAY_SECONDS) # Introduce a small delay

    print(f"\nSuccessfully generated embeddings for {len(all_embeddings)} chunks.")
    print(f"Dimension of first embedding: {len(all_embeddings[0])}")

    # You can now store these embeddings in a vector database (e.g., Vertex AI Vector Search, Pinecone, Milvus, Chroma)
    # for similarity search.

except Exception as e:
    print(f"An error occurred: {e}")
